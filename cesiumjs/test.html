<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cesium WebSocket Google Earth</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.98/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.98/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        #cesiumContainer { width: 100vw; height: 100vh; }
        #infoBox {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    <div id="infoBox">è¼‰å…¥ä¸­...</div>

    <script>
        // è¨­å®š Cesium Ion token
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIyOGRlNTU0ZC04ZjI3LTQzZTQtYjkzOC0zZDM2Mjg1M2NhMzUiLCJpZCI6MjY5MTM4LCJpYXQiOjE3NDEyNzUwNjV9.4CesGc_KCiQ7CI0-gIIQZv_5a8ilf6yukgoRkXzo2Ag';

        // åˆå§‹åŒ– Cesium Viewer
        const viewer = new Cesium.Viewer("cesiumContainer", {
            timeline: false,
            animation: false,
            sceneModePicker: false,
            baseLayerPicker: false,
            geocoder: Cesium.IonGeocodeProviderType.GOOGLE,
            globe: false // é—œé–‰é è¨­çƒé«”
        });

        // å•Ÿç”¨å¤§æ°£æ•ˆæœ
        viewer.scene.skyAtmosphere.show = true;

        const infoBox = document.getElementById('infoBox');

        // è¼‰å…¥ Google Earth Photorealistic 3D Tiles ä¸¦ç›£è½è¼‰å…¥ç‹€æ…‹
        (async () => {
            try {
                const tileset = await Cesium.createGooglePhotorealistic3DTileset({
                    onlyUsingWithGoogleGeocoder: true,
                });
                viewer.scene.primitives.add(tileset);

                // ğŸ“Œ ç›£æ¸¬ 3D Tiles æ˜¯å¦è¼‰å…¥å®Œæˆ
                tileset.readyPromise.then(() => {
                    console.log("âœ… Google Earth 3D Tiles å·²è¼‰å…¥å®Œæˆï¼");
                    infoBox.innerHTML = "âœ… Google Earth 3D Tiles å·²è¼‰å…¥ï¼";
                }).catch((error) => {
                    console.error("âŒ è¼‰å…¥ 3D Tiles å¤±æ•—:", error);
                    infoBox.innerHTML = "âŒ è¼‰å…¥ 3D Tiles å¤±æ•—ï¼";
                });

                // ğŸ“Œ ç›£æ¸¬ Tiles æ˜¯å¦é‚„åœ¨è¼‰å…¥
                viewer.scene.globe.tileLoadProgressEvent.addEventListener((count) => {
                    if (count === 0) {
                        console.log("âœ… æ‰€æœ‰å½±åƒ Tiles å·²è¼‰å…¥ï¼");
                        infoBox.innerHTML = "âœ… æ‰€æœ‰å½±åƒ Tiles å·²è¼‰å…¥ï¼";
                    } else {
                        console.log(`â³ é‚„æœ‰ ${count} å€‹ Tiles æ­£åœ¨è¼‰å…¥ä¸­...`);
                        infoBox.innerHTML = `â³ é‚„æœ‰ ${count} å€‹ Tiles æ­£åœ¨è¼‰å…¥ä¸­...`;
                    }
                });

                // ğŸ“Œ ä½¿ç”¨ `frameState` åµæ¸¬æ˜¯å¦æœ‰ Tiles é‚„åœ¨è¼‰å…¥
                viewer.scene.postRender.addEventListener(() => {
                    const tilesLoading = viewer.scene.frameState.numberOfTilesLoading;
                    if (tilesLoading === 0) {
                        infoBox.innerHTML = "âœ… æ‰€æœ‰å½±åƒå®Œå…¨è¼‰å…¥ï¼";
                    } else {
                        infoBox.innerHTML = `â³ é‚„æœ‰ ${tilesLoading} å€‹ Tiles æ­£åœ¨è¼‰å…¥ä¸­...`;
                    }
                });

            } catch (error) {
                console.log(`Error loading Photorealistic 3D Tiles tileset. ${error}`);
            }
        })();

        // å»ºç«‹ WebSocket é€£ç·š
        const ws = new WebSocket('ws://localhost:8080');

        ws.onopen = () => {
            console.log("âœ… WebSocket é€£ç·šæˆåŠŸ");
            ws.send(JSON.stringify({ identify: "cesium" }));
        };

        ws.onmessage = event => {
            try {
                const data = JSON.parse(event.data);

                // è‹¥æ”¶åˆ°ä¼ºæœå™¨ç¢ºèªè­˜åˆ¥çš„è¨Šæ¯
                if (data.status === "connected") {
                    console.log("ä¼ºæœå™¨ç¢ºèªè­˜åˆ¥:", data.message);
                    infoBox.innerHTML = `ä¼ºæœå™¨ç¢ºèª: ${data.message}`;
                    return;
                }

                // å‡è¨­æ”¶åˆ°çš„æ˜¯åº§æ¨™æ›´æ–°çš„è³‡æ–™
                console.log("æ”¶åˆ°è¦–è§’æ•¸æ“š:", data);
                infoBox.innerHTML = `
                    åº§æ¨™æ›´æ–°:<br>
                    ç¶“åº¦: ${data.longitude.toFixed(5)}<br>
                    ç·¯åº¦: ${data.latitude.toFixed(5)}<br>
                    é«˜åº¦: ${data.height}
                `;

                // æ›´æ–° Cesium ç›¸æ©Ÿè¦–è§’åˆ°ä¼ºæœå™¨æä¾›çš„åº§æ¨™
                viewer.camera.setView({
                    destination: Cesium.Cartesian3.fromDegrees(
                        data.longitude,
                        data.latitude,
                        data.height
                    ),
                    orientation: {
                        heading: Cesium.Math.toRadians(data.heading || 0),
                        pitch: Cesium.Math.toRadians(data.pitch || -90),
                        roll: Cesium.Math.toRadians(data.roll || 0)
                    }
                });
            } catch (error) {
                console.error("è³‡æ–™è§£æéŒ¯èª¤:", error, event.data);
            }
        };

        ws.onerror = error => {
            console.error("WebSocket éŒ¯èª¤:", error);
            infoBox.innerHTML = "WebSocket é€£ç·šç™¼ç”ŸéŒ¯èª¤";
        };

        ws.onclose = () => {
            console.log("WebSocket é€£ç·šå·²é—œé–‰");
            infoBox.innerHTML = "WebSocket é€£ç·šå·²é—œé–‰";
        };
    </script>
</body>
</html>
