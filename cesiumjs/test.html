<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cesium WebSocket Google Earth</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.98/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.98/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        #cesiumContainer { width: 100vw; height: 100vh; }
        #infoBox {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    <div id="infoBox">載入中...</div>

    <script>
        // 設定 Cesium Ion token
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIyOGRlNTU0ZC04ZjI3LTQzZTQtYjkzOC0zZDM2Mjg1M2NhMzUiLCJpZCI6MjY5MTM4LCJpYXQiOjE3NDEyNzUwNjV9.4CesGc_KCiQ7CI0-gIIQZv_5a8ilf6yukgoRkXzo2Ag';

        // 初始化 Cesium Viewer
        const viewer = new Cesium.Viewer("cesiumContainer", {
            timeline: false,
            animation: false,
            sceneModePicker: false,
            baseLayerPicker: false,
            geocoder: Cesium.IonGeocodeProviderType.GOOGLE,
            globe: false // 關閉預設球體
        });

        // 啟用大氣效果
        viewer.scene.skyAtmosphere.show = true;

        const infoBox = document.getElementById('infoBox');

        // 載入 Google Earth Photorealistic 3D Tiles 並監聽載入狀態
        (async () => {
            try {
                const tileset = await Cesium.createGooglePhotorealistic3DTileset({
                    onlyUsingWithGoogleGeocoder: true,
                });
                viewer.scene.primitives.add(tileset);

                // 📌 監測 3D Tiles 是否載入完成
                tileset.readyPromise.then(() => {
                    console.log("✅ Google Earth 3D Tiles 已載入完成！");
                    infoBox.innerHTML = "✅ Google Earth 3D Tiles 已載入！";
                }).catch((error) => {
                    console.error("❌ 載入 3D Tiles 失敗:", error);
                    infoBox.innerHTML = "❌ 載入 3D Tiles 失敗！";
                });

                // 📌 監測 Tiles 是否還在載入
                viewer.scene.globe.tileLoadProgressEvent.addEventListener((count) => {
                    if (count === 0) {
                        console.log("✅ 所有影像 Tiles 已載入！");
                        infoBox.innerHTML = "✅ 所有影像 Tiles 已載入！";
                    } else {
                        console.log(`⏳ 還有 ${count} 個 Tiles 正在載入中...`);
                        infoBox.innerHTML = `⏳ 還有 ${count} 個 Tiles 正在載入中...`;
                    }
                });

                // 📌 使用 `frameState` 偵測是否有 Tiles 還在載入
                viewer.scene.postRender.addEventListener(() => {
                    const tilesLoading = viewer.scene.frameState.numberOfTilesLoading;
                    if (tilesLoading === 0) {
                        infoBox.innerHTML = "✅ 所有影像完全載入！";
                    } else {
                        infoBox.innerHTML = `⏳ 還有 ${tilesLoading} 個 Tiles 正在載入中...`;
                    }
                });

            } catch (error) {
                console.log(`Error loading Photorealistic 3D Tiles tileset. ${error}`);
            }
        })();

        // 建立 WebSocket 連線
        const ws = new WebSocket('ws://localhost:8080');

        ws.onopen = () => {
            console.log("✅ WebSocket 連線成功");
            ws.send(JSON.stringify({ identify: "cesium" }));
        };

        ws.onmessage = event => {
            try {
                const data = JSON.parse(event.data);

                // 若收到伺服器確認識別的訊息
                if (data.status === "connected") {
                    console.log("伺服器確認識別:", data.message);
                    infoBox.innerHTML = `伺服器確認: ${data.message}`;
                    return;
                }

                // 假設收到的是座標更新的資料
                console.log("收到視角數據:", data);
                infoBox.innerHTML = `
                    座標更新:<br>
                    經度: ${data.longitude.toFixed(5)}<br>
                    緯度: ${data.latitude.toFixed(5)}<br>
                    高度: ${data.height}
                `;

                // 更新 Cesium 相機視角到伺服器提供的座標
                viewer.camera.setView({
                    destination: Cesium.Cartesian3.fromDegrees(
                        data.longitude,
                        data.latitude,
                        data.height
                    ),
                    orientation: {
                        heading: Cesium.Math.toRadians(data.heading || 0),
                        pitch: Cesium.Math.toRadians(data.pitch || -90),
                        roll: Cesium.Math.toRadians(data.roll || 0)
                    }
                });
            } catch (error) {
                console.error("資料解析錯誤:", error, event.data);
            }
        };

        ws.onerror = error => {
            console.error("WebSocket 錯誤:", error);
            infoBox.innerHTML = "WebSocket 連線發生錯誤";
        };

        ws.onclose = () => {
            console.log("WebSocket 連線已關閉");
            infoBox.innerHTML = "WebSocket 連線已關閉";
        };
    </script>
</body>
</html>
