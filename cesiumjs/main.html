<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>é£›è¡Œå°æ§ç«™ - Cesium ä»»å‹™ä»‹é¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.127/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.127/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    /* âœ… CSS è®Šæ•¸ï¼Œæ–¹ä¾¿çµ±ä¸€ç®¡ç†é¡è‰²ä¸»é¡Œ */
    :root {
      --primary-color: #00d9ff; /* ä¸»è‰²èª¿ï¼šç§‘æŠ€è— */
      --background-color: rgba(10, 25, 40, 0.6); /* é¢æ¿èƒŒæ™¯è‰² */
      --border-color: rgba(0, 217, 255, 0.4); /* é‚Šæ¡†é¡è‰² */
      --text-color: #e0faff; /* ä¸»è¦æ–‡å­—é¡è‰² */
      --label-color: rgba(224, 250, 255, 0.6); /* æ¨™ç±¤æ–‡å­—é¡è‰² */
      --glow-color: rgba(0, 217, 255, 0.8); /* å…‰æšˆæ•ˆæœé¡è‰² */
      --warning-color: #ff9900; /* è­¦å‘Šè‰²ï¼šç¥ç€è‰² */
      --warning-glow-color: rgba(255, 153, 0, 0.8);
      --warning-glow-secondary: rgba(255, 0, 0, 0.5);
    }

    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: black;
      font-family: 'Orbitron', 'Microsoft JhengHei', sans-serif; /* å¥—ç”¨æ–°å­—é«” */
      color: var(--text-color);
    }

    /* âœ… Cesium å®¹å™¨ */
    #cesiumContainer {
      width: 1920px;
      height: 1080px;
      margin: 0 auto;
      display: block;
      position: relative;
    }

    /* âœ… HUD é¢æ¿é€šç”¨æ¨£å¼ */
    .hud-panel {
      position: absolute;
      background: var(--background-color);
      border: 1px solid var(--border-color);
      padding: 15px 20px;
      backdrop-filter: blur(8px); /* ç»ç’ƒæ“¬æ…‹æ•ˆæœ */
      -webkit-backdrop-filter: blur(8px);
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.5), inset 0 0 10px rgba(10, 25, 40, 0.7);
      z-index: 1000;
    }

    /* âœ… ä½¿ç”¨å½å…ƒç´ è£½ä½œé¢æ¿çš„è£é£¾æ€§é‚Šè§’ */
    .hud-panel::before,
    .hud-panel::after {
      content: '';
      position: absolute;
      width: 15px;
      height: 15px;
      border-color: var(--primary-color);
      border-style: solid;
    }
    .hud-panel::before { top: -2px; left: -2px; border-width: 2px 0 0 2px; }
    .hud-panel::after { top: -2px; right: -2px; border-width: 2px 2px 0 0; }
    
    .panel-bottom-left::before, .panel-bottom-left::after,
    .panel-bottom-right::before, .panel-bottom-right::after {
        border-width: 0;
    }

    .panel-bottom-left::before { bottom: -2px; left: -2px; border-width: 0 0 2px 2px; }
    .panel-bottom-left::after { bottom: -2px; right: -2px; border-width: 0 2px 2px 0; }
    .panel-bottom-right::before { bottom: -2px; left: -2px; border-width: 0 0 2px 2px; }
    .panel-bottom-right::after { bottom: -2px; right: -2px; border-width: 0 2px 2px 0; }


    /* âœ… é¢æ¿æ¨™é¡Œ */
    .panel-header {
      font-size: 1.1em;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 12px;
      letter-spacing: 2px;
      text-shadow: 0 0 5px var(--glow-color);
    }

    /* âœ… å„é¢æ¿å®šä½ */
    .panel-top-left { top: 20px; left: 20px; }
    .panel-bottom-left { bottom: 20px; left: 20px; }
    .panel-bottom-right { bottom: 20px; right: 20px; }

    /* âœ… é™æ¸¬æ•¸æ“šé …ç›®æ¨£å¼ */
    #infoBox .telemetry-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 0.9em;
    }
    #infoBox .label {
      color: var(--label-color);
      margin-right: 20px;
    }
    #infoBox .value {
      color: var(--text-color);
      font-weight: bold;
    }
    
    /* âœ… ç‹€æ…‹é¡¯ç¤ºæ¨£å¼ */
    #statusBox {
      font-size: 1em;
      padding: 5px 0;
      font-weight: bold;
      color: #90ee90; /* é è¨­ä¸€å€‹æ˜äº®çš„é¡è‰² */
    }

    /* âœ… è¨ˆç®—çµæœæ¨£å¼ */
    #resultBox .result-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 0.9em;
    }
    #resultBox .label { color: var(--label-color); margin-right: 20px; }
    #resultBox .value { color: var(--text-color); font-weight: bold; }
    
    /* âœ… æˆªåœ–é è¦½æ¨£å¼ */
    #screenshotPreview {
        border: 2px solid var(--primary-color) !important;
        box-shadow: 0 0 10px var(--glow-color);
    }
    
    /* âœ…ã€æ–°å¢ã€‘ç”¨æ–¼ GPS æ–·ç·šçš„è­¦å‘Šæ¨£å¼ */
    #infoBox.warning-state {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 205px; 
      font-size: 1.6em;
      font-weight: 700;
      color: var(--warning-color);
      text-shadow: 0 0 8px var(--warning-glow-color), 0 0 12px var(--warning-glow-secondary);
      animation: pulse-warning 2s infinite ease-in-out;
    }

    /* âœ…ã€æ–°å¢ã€‘è­¦å‘Šå‹•ç•«çš„ Keyframes */
    @keyframes pulse-warning {
      0% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.8;
        transform: scale(1.02);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

  </style>
</head>
<body>
  <div id="cesiumContainer"></div>

  <div class="hud-panel panel-top-left">
    <div class="panel-header">FLIGHT TELEMETRY</div>
    <div id="infoBox">ç­‰å¾…ä¼ºæœå™¨é€£ç·š...</div>
  </div>

  <div class="hud-panel panel-bottom-left">
    <div class="panel-header">SYSTEM STATUS</div>
    <div id="statusBox">åˆå§‹åŒ–åœ–è³‡ä¸­...</div>
  </div>

  <div class="hud-panel panel-bottom-right">
    <div class="panel-header">NAVIGATION RESULT</div>
    <div id="resultBox">-</div>
  </div>

  <script>
    // âœ… è¨­å®š Cesium Ion token
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIyOGRlNTU0ZC04ZjI3LTQzZTQtYjkzOC0zZDM2Mjg1M2NhMzUiLCJpZCI6MjY5MTM4LCJpYXQiOjE3NDEyNzUwNjV9.4CesGc_KCiQ7CI0-gIIQZv_5a8ilf6yukgoRkXzo2Ag';

    // âœ… åˆå§‹åŒ– Viewer
    const viewer = new Cesium.Viewer("cesiumContainer", {
      timeline: false,
      animation: false,
      sceneModePicker: false,
      baseLayerPicker: false,
      geocoder: Cesium.IonGeocodeProviderType.GOOGLE,
      globe: false,
      contextOptions: {
        preserveDrawingBuffer: true
      }
    });
    viewer.scene.skyAtmosphere.show = true;

    // âœ… å¼·åˆ¶ç•«é¢è§£æåº¦
    const width = 1920;
    const height = 1080;
    viewer.container.style.width = width + 'px';
    viewer.container.style.height = height + 'px';
    viewer.scene.canvas.width = width;
    viewer.scene.canvas.height = height;
    viewer.resolutionScale = 1.0;
    viewer.scene.requestRender();

    // å–å¾— UI å…ƒç´ 
    const infoBox = document.getElementById('infoBox');
    const statusBox = document.getElementById('statusBox');
    const resultBox = document.getElementById('resultBox');

    // âœ¨ æ›´æ–°é™æ¸¬æ•¸æ“šçš„å‡½å¼
    function updateInfoBox(data) {
      infoBox.innerHTML = `
        <div class="telemetry-item"><span class="label">ç¶“åº¦ (LON)</span><span class="value">${data.longitude.toFixed(5)}</span></div>
        <div class="telemetry-item"><span class="label">ç·¯åº¦ (LAT)</span><span class="value">${data.latitude.toFixed(5)}</span></div>
        <div class="telemetry-item"><span class="label">é«˜åº¦ (ALT)</span><span class="value">${data.height.toFixed(2)} m</span></div>
        <div class="telemetry-item"><span class="label">æœå‘ (HDG)</span><span class="value">${data.heading}Â°</span></div>
        <div class="telemetry-item"><span class="label">ä¿¯ä»° (PIT)</span><span class="value">${data.pitch}Â°</span></div>
        <div class="telemetry-item"><span class="label">ç¿»æ»¾ (ROL)</span><span class="value">${data.roll}Â°</span></div>
      `;
    }

    let firstCapture = true;
    let captureWait = 1500;

    // âœ… WebSocket
    let ws;
    function connectWebSocket() {
      if (!ws || ws.readyState === WebSocket.CLOSED) {
        ws = new WebSocket('ws://localhost:8080');

        ws.onopen = () => {
          console.log("âœ… WebSocket é€£ç·šæˆåŠŸ");
          statusBox.textContent = "å·²é€£ç·šè‡³ä¼ºæœå™¨";
          ws.send(JSON.stringify({ identify: "cesium" }));
        };

        ws.onmessage = event => {
          try {
            const data = JSON.parse(event.data);
            
            if (data.status === "connected") {
              console.log("ä¼ºæœå™¨ç¢ºèªè­˜åˆ¥:", data.message);
              infoBox.innerHTML = `ä¼ºæœå™¨å·²é€£ç·š: <span style="color: var(--primary-color);">${data.message}</span>`;
              return;
            }

            if (data.action === "get_cesium_picture") {
              console.log("æ”¶åˆ°è§¸ç™¼è¨Šæ¯: åŸ·è¡Œ get_cesium_picture");
              statusBox.textContent = "GPSè¨Šè™Ÿä¸­æ–·ï¼ŒåŸ·è¡Œå½±åƒå®šä½";
              
              // âœ…ã€ä¿®æ”¹ã€‘åŠ ä¸Šè­¦å‘Š class
              infoBox.classList.add('warning-state'); 
              infoBox.innerHTML = "GPS æ–·ç·š";

              captureAndUpload();
              return;
            }

            if (data.action === "send_Coordinates") {
              console.log("æ”¶åˆ°ç›¸æ©Ÿåº§æ¨™è³‡æ–™ï¼Œæ›´æ–°æ”å½±æ©Ÿç•«é¢");
              
              // âœ…ã€ä¿®æ”¹ã€‘ç§»é™¤è­¦å‘Š class
              infoBox.classList.remove('warning-state'); 
              
              statusBox.textContent = "GPSè¨Šè™Ÿæ­£å¸¸";
              updateInfoBox(data);
              viewer.camera.setView({
                destination: Cesium.Cartesian3.fromDegrees(data.longitude, data.latitude, data.height),
                orientation: {
                  heading: Cesium.Math.toRadians(data.heading || 0),
                  pitch: Cesium.Math.toRadians(data.pitch || -90),
                  roll: Cesium.Math.toRadians(data.roll || 0)
                }
              });
            }
            
            if (data.action === "renew_cesium") {
              // âœ…ã€ä¿®æ”¹ã€‘ç§»é™¤è­¦å‘Š class
              infoBox.classList.remove('warning-state'); 

              statusBox.textContent = "GPSè¨Šè™Ÿæ­£å¸¸";
              viewer.camera.setView({
                destination: Cesium.Cartesian3.fromDegrees(data.longitude, data.latitude, data.height),
                orientation: {
                  heading: Cesium.Math.toRadians(data.heading || 0),
                  pitch: Cesium.Math.toRadians(data.pitch || -90),
                  roll: Cesium.Math.toRadians(data.roll || 0)
                }
              });
              updateInfoBox(data);
              if (firstCapture) {
                setTimeout(() => { firstCapture = false; }, 10000);
              }
            }

            if (data.action === "send_pixel_Coordinates") {
              console.log("âœ… æ”¶åˆ° pixel åº§æ¨™è¦æ±‚ï¼ˆsend_pixel_Coordinatesï¼‰è¨Šæ¯");
              return;
            }

            if (data.action === "top_match_pixels") {
              console.log("âœ… æ”¶åˆ° top_match_pixels è¨Šæ¯");
              const scene = viewer.scene;
              const results = [];
              data.pixels.forEach((pixel, index) => {
                const screenPosition = new Cesium.Cartesian2(pixel.x, pixel.y);
                const worldPosition = scene.pickPosition(screenPosition);
                if (Cesium.defined(worldPosition)) {
                  const cartographic = Cesium.Cartographic.fromCartesian(worldPosition);
                  results.push({
                    x: pixel.x, y: pixel.y,
                    longitude: Cesium.Math.toDegrees(cartographic.longitude),
                    latitude: Cesium.Math.toDegrees(cartographic.latitude),
                    height: cartographic.height
                  });
                  viewer.entities.add({
                    position: worldPosition,
                    point: { pixelSize: 6, color: Cesium.Color.YELLOW },
                    label: {
                      text: `(${pixel.x.toFixed(0)}, ${pixel.y.toFixed(0)})`,
                      font: "10pt sans-serif",
                      fillColor: Cesium.Color.WHITE,
                      style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                      outlineWidth: 1,
                      verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                      pixelOffset: new Cesium.Cartesian2(0, -10)
                    }
                  });
                } else {
                  console.warn(`âš ï¸ ç¬¬ ${index + 1} é» (${pixel.x}, ${pixel.y}) ç„¡æ³•å–å¾—ä¸–ç•Œåº§æ¨™`);
                }
              });
              console.log("ğŸ“Œ è½‰æ›å®Œæˆçš„ 3D åº§æ¨™ï¼š", results);
              if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                  action: "got_match_world_coordinates",
                  points: results
                }));
              }
              return;
            }

            if (data.action === "status_update") {
              const map = {
                waiting_drone: "ç­‰å¾…ç„¡äººæ©Ÿå›å‚³å½±åƒ",
                superglue: "å½±åƒç‰¹å¾µåŒ¹é… (SuperGlue)",
                calculation_done: "åº§æ¨™è§£ç®—å®Œæˆ"
              };
              statusBox.textContent = `${map[data.step] || data.step}`;
              return;
            }

            if (data.action === "calculation_result") {
              resultBox.innerHTML = `
                <div class="result-item"><span class="label">ç¶“åº¦</span><span class="value">${data.longitude.toFixed(6)}</span></div>
                <div class="result-item"><span class="label">ç·¯åº¦</span><span class="value">${data.latitude.toFixed(6)}</span></div>
                <div class="result-item"><span class="label">é«˜åº¦</span><span class="value">${data.height.toFixed(2)} m</span></div>
              `;
              return;
            }

          } catch (error) {
            console.error("è³‡æ–™è§£æéŒ¯èª¤:", error, event.data);
          }
        };

        ws.onerror = error => {
          console.error("âŒ WebSocket éŒ¯èª¤:", error);
          statusBox.textContent = "WebSocket é€£ç·šéŒ¯èª¤";
          infoBox.innerHTML = "WebSocket é€£ç·šç™¼ç”ŸéŒ¯èª¤";
        };

        ws.onclose = () => {
          console.warn("âš ï¸ WebSocket é—œé–‰ï¼Œ3 ç§’å¾Œé‡æ–°é€£ç·š...");
          statusBox.textContent = "é€£ç·šä¸­æ–·ï¼Œå˜—è©¦é‡é€£...";
          infoBox.innerHTML = "WebSocket é€£ç·šå·²é—œé–‰";
          setTimeout(connectWebSocket, 3000);
        };
      }
    }

    // âœ… å•Ÿå‹• WebSocket
    connectWebSocket();

    // âœ… è¼‰å…¥ Google Earth 3D Tiles
    (async () => {
      try {
        statusBox.textContent = 'åˆå§‹åŒ–åœ–è³‡ä¸­...';
        const tileset = await Cesium.createGooglePhotorealistic3DTileset({
          onlyUsingWithGoogleGeocoder: true,
        });
        viewer.scene.primitives.add(tileset);
        statusBox.textContent = 'åœ–è³‡è¼‰å…¥å®Œæˆï¼Œç­‰å¾…é€£ç·š';
      } catch (error) {
        console.error(`âŒ Error loading 3D Tiles: ${error}`);
        statusBox.textContent = '3D åœ–è³‡è¼‰å…¥å¤±æ•—ï¼';
      }
    })();

    // âœ… æ“·å–ç•«é¢ä¸¦ä¸Šå‚³
    function captureAndUpload() {
      console.log("é–‹å§‹æˆªåœ–");
      setTimeout(() => {
        viewer.scene.render();
        const canvas = viewer.scene.canvas;
        const dataURL = canvas.toDataURL("image/png");
        console.log("æˆªåœ–å®Œæˆ");
        displayCapturedImage(dataURL);
        fetch("http://localhost:8081/upload", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ image: dataURL })
        })
        .then(response => response.json())
        .then(data => {
          console.log("ä¸Šå‚³æˆåŠŸ", data);
          statusBox.textContent = "å½±åƒä¸Šå‚³å®Œæˆï¼Œç­‰å¾…åŒ¹é…";
          if (ws && ws.readyState === WebSocket.OPEN) {
            setTimeout(() => {
              ws.send(JSON.stringify({ action: "upload_success" }));
              console.log("âœ… å·²é€é WebSocket é€šçŸ¥ä¼ºæœå™¨åœ–ç‰‡ä¸Šå‚³å®Œæˆ");
            }, 1500);
          } else {
            console.warn("âš ï¸ WebSocket å°šæœªé€£ç·šï¼Œç„¡æ³•ç™¼é€ä¸Šå‚³æˆåŠŸé€šçŸ¥");
          }
        })
        .catch(error => {
          console.error("ä¸Šå‚³å¤±æ•—", error);
          statusBox.textContent = "å½±åƒä¸Šå‚³å¤±æ•—";
        });
      }, captureWait);
    }
    
    // âœ… é¡¯ç¤ºé è¦½åœ–ç‰‡
    function displayCapturedImage(dataURL) {
      const img = document.getElementById("screenshotPreview") || document.createElement("img");
      img.id = "screenshotPreview";
      img.src = dataURL;
      img.style.position = "absolute";
      img.style.top = "20px";
      img.style.right = "20px";
      img.style.width = "240px";
      img.style.border = "2px solid red"; /* é€™æœƒè¢« CSS ä¸­çš„ !important è¦†è“‹ */
      img.style.background = "#fff";
      img.style.zIndex = "2000"; /* ç¢ºä¿åœ¨é¢æ¿ä¹‹ä¸Š */
      
      if (!document.getElementById("screenshotPreview")) {
        document.body.appendChild(img);
      }
    }
  </script>
</body>
</html>